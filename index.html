<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>T·∫øt Trung Thu ‚ú®üåï</title>
  <meta name="description" content="Thi·ªáp web Trung Thu c√≥ nh·∫°c, hi·ªáu ·ª©ng ph√°o hoa v√† l·ªùi ch√∫c √Ω nghƒ©a. T√πy bi·∫øn t√™n ng∆∞·ªùi nh·∫≠n & chia s·∫ª d·ªÖ d√†ng." />
  <meta property="og:title" content="Thi·ªáp Trung Thu c·ªßa b·∫°n" />
  <meta property="og:description" content="M·ªü thi·ªáp ƒë·ªÉ nghe nh·∫°c v√† nh·∫≠n l·ªùi ch√∫c Trung Thu th·∫≠t √Ω nghƒ©a!" />
  <meta property="og:type" content="website" />
  <meta name="theme-color" content="#0b1b3a" />
  <link rel="preload" as="audio" href="trungthu.mp3" />
  <link rel="preload" as="audio" href="phao.mp3" />
  <link rel="preload" as="audio" href="trungthu1.mp3" />
  <link rel="preload" as="audio" href="trungthu2.mp3" />
  <link rel="preload" as="audio" href="trungthu3.mp3" />
  <link rel="preload" as="audio" href="trungthu4.mp3" />
  <link rel="preload" as="audio" href="phao1.mp3" />
  <style>
    :root{
      --bg1:#0b1b3a;
      --bg2:#1b335f;
      --moon:#ffe9a3;
      --lantern:#ffb84d;
      --accent:#ffd166;
      --paper:#fff7e6;
      --glass: rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:#f5f7ff; background: radial-gradient(1200px 800px at 70% -10%, #254273 0%, transparent 60%), linear-gradient(180deg, var(--bg2), var(--bg1)); overflow:hidden}

    .stars{position:fixed; inset:0; pointer-events:none}
    .stars i{position:absolute; width:2px; height:2px; background:#cfe3ff; opacity:.9; border-radius:50%; animation: twinkle 3.5s infinite ease-in-out}
    @keyframes twinkle{50%{transform:scale(1.6); opacity:.4}}

    .moon{position:absolute; top:4vh; right:6vw; width:120px; height:120px; background:radial-gradient(circle at 30% 30%, #fff7d1 20%, var(--moon) 60%, #f7d77a 100%); border-radius:50%; box-shadow:0 0 30px 10px rgba(255,233,163,.3), 0 0 100px rgba(255,233,163,.2)}

    .lantern{position:absolute; bottom:-140px; width:42px; height:60px; background:linear-gradient(180deg, #ffcf70, var(--lantern)); border-radius:10px; box-shadow:0 -8px 18px rgba(255,209,102,.35) inset, 0 8px 18px rgba(0,0,0,.25) inset, 0 0 24px rgba(255,184,77,.5); transform:translateY(0) scale(1); animation: floatUp 16s linear infinite}
    .lantern::before{content:""; position:absolute; left:50%; top:-16px; width:22px; height:16px; transform:translateX(-50%); background:linear-gradient(180deg, #fbe7b8, #ffd166); border-radius:4px 4px 0 0}
    .lantern::after{content:""; position:absolute; left:50%; bottom:-14px; width:18px; height:14px; transform:translateX(-50%); background:linear-gradient(180deg, #ffebc6, #ffb84d); border-radius:0 0 4px 4px; box-shadow:0 4px 12px rgba(255,184,77,.7)}
    @keyframes floatUp{0%{transform:translateY(0)}100%{transform:translateY(-120vh)}}

    .wrap{position:relative; z-index:2; height:100dvh; display:grid; place-items:center; padding:24px}
    .card{width:min(920px,92vw); background:linear-gradient(180deg, rgba(255,255,255,.1), rgba(255,255,255,.06)); border:1px solid rgba(255,255,255,.18); border-radius:24px; box-shadow:0 20px 60px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.2); backdrop-filter:blur(10px); overflow:hidden}
    .card-header{display:flex; align-items:center; gap:14px; padding:18px 22px; background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.02)); border-bottom:1px solid rgba(255,255,255,.15)}
    .title{font-size:clamp(22px,2.6vw,32px); margin:0; font-weight:800}
    .subtitle{opacity:.85; font-size:clamp(13px,1.4vw,15px)}
    .paper{background:var(--paper); color:#3b2f1a; padding:22px; border-radius:14px; box-shadow:inset 0 2px 0 #fff, 0 10px 24px rgba(0,0,0,.15)}

    .content{display:grid; grid-template-columns:1.1fr .9fr; gap:18px; padding:22px}
    @media(max-width:860px){.content{grid-template-columns:1fr; gap:14px}}

    .wish{min-height:170px; line-height:1.6; font-size:clamp(17px,2vw,20px)}

    .actions{display:flex; flex-wrap:wrap; gap:10px; margin-top:14px}
    button,.ghost{border:0; padding:10px 14px; border-radius:999px; font-weight:700; cursor:pointer; background:#1e293b; color:#e9f1ff; border:1px solid rgba(255,255,255,.2); transition:.2s}
    button:hover,.ghost:hover{transform:translateY(-1px); box-shadow:0 8px 20px rgba(0,0,0,.25)}
    button.primary{background:linear-gradient(180deg,#ffd166,#ffb84d); color:#3b2f1a; border-color:#f59f0b}
    .ghost{background:#334155; color:#e9f1ff; border-color:rgba(255,255,255,.55)}
    #btnShare.ghost{background:linear-gradient(180deg,#ffd166,#ffb84d); color:#3b2f1a; border-color:#f59f0b; box-shadow:0 8px 20px rgba(255,184,77,.4)}

    .greeting{font-weight:800; font-size:clamp(18px,2.2vw,22px); margin:0 0 6px}
    .small{font-size:13px; opacity:.8}

    .editor{margin-top:12px}
    .editor label{display:block; margin:6px 0; font-weight:700; color:#3b2f1a}
    .editor textarea{width:100%; min-height:80px; padding:10px; border-radius:12px; border:1px solid rgba(0,0,0,.1); font-family:inherit; font-size:15px; color:#3b2f1a; background:#fffdf7}

    .audio-toggle{position:fixed; right:18px; bottom:18px; z-index:10; width:54px; height:54px; display:grid; place-items:center; border-radius:50%; background:var(--glass); border:1px solid rgba(255,255,255,.3); backdrop-filter:blur(8px); cursor:pointer}
    .audio-toggle svg{width:26px; height:26px; fill:#fff}
    .audio-hint{position:fixed; right:18px; bottom:80px; background:var(--glass); border:1px solid rgba(255,255,255,.25); padding:8px 12px; border-radius:10px; font-size:12px}

    .overlay{position:fixed; inset:0; background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.75)); display:grid; place-items:center; z-index:20}
    .overlay .box{width:min(560px,92vw); text-align:center}

    #fxBack{position:fixed; inset:0; pointer-events:none; z-index:1}
    #fx{position:fixed; inset:0; pointer-events:none; z-index:3}

    footer{padding:10px 18px; text-align:center; opacity:.8; font-size:12px}
    /* --- Mobile fixes & responsive polish --- */
    body{ overflow-y:auto; }
    .wrap{ height:auto; min-height:100svh; padding:16px; }
    .card{ margin:10px auto; }
    .audio-toggle{ bottom: calc(max(18px, env(safe-area-inset-bottom))); right: calc(18px + env(safe-area-inset-right)); }
    footer{ padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
    button, .ghost{ min-height:44px; touch-action:manipulation }
    @media (max-width: 600px){
      .content{ grid-template-columns:1fr; gap:12px; padding:14px }
      .paper{ padding:16px }
      .actions{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
      #btnShare{ grid-column:1/-1 }
      .title{ font-size:22px }
    }
  </style>
</head>
<body>
  <canvas id="fxBack"></canvas>
  <canvas id="fx"></canvas>
  <div class="stars"></div>
  <div class="moon"></div>
  <div class="wrap">
    <div class="card">
      <div class="card-header">
        <h1 class="title">T·∫øt Trung Thu ‚Äì TrƒÉng tr√≤n ƒëo√†n vi√™n</h1>
        <div class="subtitle">M·ªü thi·ªáp ƒë·ªÉ nghe nh·∫°c v√† nh·∫≠n nh·ªØng l·ªùi ch√∫c √Ω nghƒ©a ‚ú®</div>
      </div>
      <div class="content">
        <section class="paper">
          <p class="greeting" id="greeting"></p>
          <div id="wish" class="wish"><span id="wishText"></span></div>
          <div class="actions">
            <button class="primary" id="btnRandom">Ng·∫´u nhi√™n</button>
            <button id="btnPrev">‚óÄ</button>
            <button id="btnNext">‚ñ∂</button>
            <button id="btnCopy">Sao ch√©p</button>
            <button id="btnSong">ƒê·ªïi nh·∫°c</button>
            <a class="ghost" id="btnShare" href="#">Chia s·∫ª</a>
          </div>
          <div class="editor">
            <label for="customInput">T·ª± vi·∫øt l·ªùi ch√∫c</label>
            <textarea id="customInput" placeholder="Nh·∫≠p l·ªùi ch√∫c..."></textarea>
            <div class="actions">
              <button id="btnUse">C·∫≠p nh·∫≠t</button>
              <button id="btnAddWish">Th√™m m·ªõi</button>
              <button class="ghost" id="btnReset">Kh√¥i ph·ª•c</button>
            </div>
          </div>
          <p class="small">Nh·∫°c: <b id="trackName">trungthu</b></p>
        </section>
        <section>
          <div class="paper">
            <h3>√ù nghƒ©a ƒë√™m r·∫±m</h3>
            <p>Trung Thu l√† kho·∫£nh kh·∫Øc c·∫£ nh√† qu√¢y qu·∫ßn d∆∞·ªõi v·∫ßng trƒÉng tr√≤n, nh·∫Øc nhau g√¨n gi·ªØ y√™u th∆∞∆°ng, s·∫ª chia v√† bi·∫øt ∆°n.</p>
            <div class="actions">
              <button id="btnFire">üéá B·∫Øn ph√°o hoa</button>
              <button id="btnRemote">üì° Ph√°o t·∫ßm xa</button>
              <button id="btnLantern">üèÆ Th·∫£ ƒë√®n</button>
            </div>
          </div>
        </section>
      </div>
      <footer>Made with ‚ô• | T·∫°o l·ªùi ch√∫c t·∫°i ƒë√¢y: link</footer>
    </div>
  </div>

  <audio id="bgm" src="trungthu.mp3" preload="auto" loop></audio>
  <audio id="phao" src="phao.mp3" preload="auto"></audio>
  <audio id="phao1" src="phao1.mp3" preload="auto"></audio>
  <button class="audio-toggle" id="audioToggle"><svg id="iconPlay" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg><svg id="iconPause" viewBox="0 0 24 24" style="display:none"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg></button>
  <div class="audio-hint" id="audioHint" hidden>Nh·∫•n ƒë·ªÉ b·∫≠t nh·∫°c ‚ô´</div>

  <div class="overlay" id="overlay">
    <div class="box paper">
      <h2>Ch√∫c Trung Thu vui v·∫ª! üåï</h2>
      <div class="actions"><button class="primary" id="startBtn">B·∫≠t nh·∫°c & b·∫Øt ƒë·∫ßu</button><button class="ghost" id="skipBtn">V√†o xem</button></div>
    </div>
  </div>

  <script>
// ===== Helpers =====
const $ = (s, p=document) => p.querySelector(s);
const $$ = (s, p=document) => [...p.querySelectorAll(s)];
// Mobile detection to tune effects/layout
const isMobile = matchMedia('(max-width: 480px), (pointer: coarse)').matches;

// ===== Personalize via URL =====
const params = new URLSearchParams(location.search);
const toName = decodeURIComponent((params.get('to')||'').replace(/\+/g,' ')).trim();
const fromName = decodeURIComponent((params.get('from')||'').replace(/\+/g,' ')).trim();
$('#greeting').textContent = toName ? `G·ª≠i ${toName},` : 'G·ª≠i b·∫°n,';

// ===== Wishes data =====
const defaultWishes = [
  'Ch√∫c b·∫°n m·ªôt T·∫øt Trung Thu tr√≤n ƒë·∫ßy, b√¨nh an, h·∫°nh ph√∫c.',
  'Mong √°nh trƒÉng r·∫±m soi s√°ng m·ªçi d·ª± ƒë·ªãnh c·ªßa b·∫°n.',
  'Trung Thu l√† m√πa ƒëo√†n vi√™n: ch√∫c gia ƒë√¨nh b·∫°n lu√¥n b√™n nhau, th∆∞∆°ng nhau nhi·ªÅu h∆°n.',
  'Ch√∫c cho nh·ªØng ƒëi·ªÅu b·∫°n ∆∞·ªõc d∆∞·ªõi trƒÉng ƒë·ªÅu th√†nh s·ª± th·∫≠t ‚Äì ƒë√∫ng l√∫c, ƒë√∫ng c√°ch v√† ƒë·ªß duy√™n.',
  'D√π ƒëi xa ƒë·∫øn ƒë√¢u, mong b·∫°n lu√¥n t√¨m th·∫•y ƒë∆∞·ªùng v·ªÅ nh√† ‚Äì n∆°i c√≥ y√™u th∆∞∆°ng ch·ªù.',
  'Ch√∫c n·ª• c∆∞·ªùi b·∫°n tr√≤n nh∆∞ trƒÉng r·∫±m, soi r·ªçi v√† lan t·ªèa y√™u th∆∞∆°ng.',
  'Mong b√£o t·ªë n√†o c≈©ng ƒëi qua, ƒë·ªÉ b√¨nh y√™n ·ªü l·∫°i b√™n b·∫°n th·∫≠t l√¢u.',
  'Ch√∫c b·∫°n ƒë·ªß can ƒë·∫£m bu√¥ng ƒëi·ªÅu kh√¥ng ph√π h·ª£p, ƒë·ªß tr√≠ tu·ªá gi·ªØ ƒëi·ªÅu ƒë√°ng tr√¢n tr·ªçng.',
  '√Ånh trƒÉng d·ªãu d√†ng nh∆∞ l·ªùi ch√∫c: mong b·∫°n ng·ªß ngon, m∆° ƒë·∫πp.',
  'Ch√∫c gia ƒë√¨nh b·∫°n kh·ªèe m·∫°nh, thu·∫≠n h√≤a, b·ªØa c∆°m n√†o c≈©ng ƒë·∫ßy ti·∫øng c∆∞·ªùi.',
  'Ch√∫c b·∫°n lu√¥n t√¨m th·∫•y l√Ω do ƒë·ªÉ m·ªâm c∆∞·ªùi, d√π l√† nh·ªØng ng√†y r·∫•t b√¨nh th∆∞·ªùng.',
  'Mong b·∫°n ƒë·ªß duy√™n g·∫∑p may, ƒë·ªß tr√≠ ch·ªçn ƒë∆∞·ªùng, ƒë·ªß v·ªØng ƒë·ªÉ ti·∫øn.',
  // Th√™m m·ªõi cho phong ph√∫
  'Ch√∫c ƒë√™m r·∫±m ng·∫≠p tr√†n ti·∫øng c∆∞·ªùi, ƒë·ªß b√°nh ƒë·ªß tr√†, ƒë·ªß ng∆∞·ªùi th∆∞∆°ng b√™n c·∫°nh.',
  'Mong b·∫°n nh·∫π l√≤ng nh∆∞ m√¢y, s√°ng trong nh∆∞ trƒÉng, ki√™n ƒë·ªãnh nh∆∞ sao B·∫Øc ƒê·∫©u.',
  'Ch√∫c b·∫°n can ƒë·∫£m b·∫Øt ƒë·∫ßu, b·ªÅn b·ªâ ƒëi ti·∫øp v√† d·ªãu d√†ng v·ªÅ ƒë√≠ch.',
  '∆Ø·ªõc g√¨ nh·ªØng ƒëi·ªÅu b·∫°n gieo h√¥m nay s·∫Ω n·ªü hoa ƒë√∫ng m√πa ng√†y mai.',
  'Trung Thu vui ‚Äì g·ª≠i b·∫°n t√∫i qu√† b√¨nh an, g√≥i gh√©m th√™m ch√∫t may m·∫Øn.',
  'Mong m·ªçi l·ªùi ch√∫c t·ªët l√†nh t·ªëi nay ƒë·ªÅu tr·ªü th√†nh s·ª± th·∫≠t trong nƒÉm t·ªõi.',
  'Ch√∫c h√†nh tr√¨nh c·ªßa b·∫°n lu√¥n c√≥ trƒÉng soi, c√≥ b·∫°n t·ªët ƒë·ªìng h√†nh.',
  'Mong chi·∫øc tim b·∫°n lu√¥n ·∫•m, d√π ngo√†i kia c√≥ gi√≥ m√πa th·ªïi qua.',
  'Ch√∫c b·∫°n h·ªçc h√†nh ti·∫øn b·ªô, c√¥ng vi·ªác hanh th√¥ng, s·ª©c kh·ªèe d·ªìi d√†o.',
  'Ch√∫c cho t√¨nh c·∫£m b·∫°n tr√¢n tr·ªçng ƒë∆∞·ª£c ƒë√°p l·∫°i b·∫±ng s·ª± ch√¢n th√†nh x·ª©ng ƒë√°ng.',
  'Mong b·∫°n b√¨nh an ‚Äì v√¨ b√¨nh an l√† m√≥n qu√† qu√Ω nh·∫•t.',
  'Ch√∫c b·∫°n g·∫∑p g·ª° nh·ªØng ng∆∞·ªùi t·ª≠ t·∫ø v√† c≈©ng tr·ªü th√†nh ƒëi·ªÅu t·ª≠ t·∫ø cho ai ƒë√≥.'
];

let wishes;
try{
  const saved = JSON.parse(localStorage.getItem('wishesUser')||'null');
  wishes = Array.isArray(saved) && saved.length ? saved : [...defaultWishes];
}catch{ wishes = [...defaultWishes]; }

let idx = 0;
function render(){ $('#wishText').textContent = wishes[idx]; }
render();

// ===== Buttons (prev/next/random) =====
$('#btnPrev').onclick = ()=>{ idx=(idx-1+wishes.length)%wishes.length; render(); };
$('#btnNext').onclick = ()=>{ idx=(idx+1)%wishes.length; render(); };
$('#btnRandom').onclick = ()=>{ idx=Math.floor(Math.random()*wishes.length); render(); };

// ===== Copy with footer link =====
$('#btnCopy').onclick = async ()=>{
  const head = toName?`G·ª≠i ${toName}, `:'';
  const text = `${head}${wishes[idx]}
T·∫°o l·ªùi ch√∫c t·∫°i ƒë√¢y: link`;
  await navigator.clipboard.writeText(text);
  toast('ƒê√£ sao ch√©p l·ªùi ch√∫c!'); sparkle();
};

// ===== Share (sender/receiver + link + footer) =====
$('#btnShare').onclick = async (e)=>{
  e.preventDefault();
  const sender = fromName || 'M·ªôt ng∆∞·ªùi b·∫°n';
  const receiver = toName || 'b·∫°n';
  const text = `L·ªùi ch√∫c Trung Thu t·ª´ ${sender} g·ª≠i ${receiver}:
‚Äú${wishes[idx]}‚Äù
Xem thi·ªáp: link
T·∫°o l·ªùi ch√∫c t·∫°i ƒë√¢y: link`;
  try{
    if(navigator.share){
      await navigator.share({ title:'Thi·ªáp Trung Thu', text, url:'link' });
      toast('ƒê√£ m·ªü chia s·∫ª');
    } else {
      await navigator.clipboard.writeText(text);
      toast('ƒê√£ sao ch√©p n·ªôi dung chia s·∫ª!');
    }
  }catch{}
};

// ===== Custom editor (local) =====
const input=$('#customInput');
$('#btnUse').onclick=()=>{ const v=(input.value||'').trim(); if(!v) return toast('B·∫°n ch∆∞a nh·∫≠p n·ªôi dung'); wishes[idx]=v; persist(); render(); toast('ƒê√£ c·∫≠p nh·∫≠t l·ªùi ch√∫c!'); };
$('#btnAddWish').onclick=()=>{ const v=(input.value||'').trim(); if(!v) return toast('B·∫°n ch∆∞a nh·∫≠p n·ªôi dung'); wishes.push(v); idx=wishes.length-1; persist(); render(); toast('ƒê√£ th√™m l·ªùi ch√∫c!'); };
$('#btnReset').onclick=()=>{ wishes=[...defaultWishes]; idx=0; persist(); render(); toast('ƒê√£ kh√¥i ph·ª•c m·∫∑c ƒë·ªãnh'); };
function persist(){ try{ localStorage.setItem('wishesUser', JSON.stringify(wishes)); }catch{} }

// ===== Audio control & playlist =====
const audio = $('#bgm');
const toggleBtn = $('#audioToggle');
const iconPlay = $('#iconPlay');
const iconPause = $('#iconPause');
let isPlaying=false;
function updateAudioUI(){ iconPlay.style.display = isPlaying?'none':'block'; iconPause.style.display = isPlaying?'block':'none'; }
async function playAudio(){ try{ await audio.play(); isPlaying=true; updateAudioUI(); }catch(e){ $('#audioHint').hidden=false; } }
function pauseAudio(){ audio.pause(); isPlaying=false; updateAudioUI(); }

toggleBtn.addEventListener('click', ()=>{ isPlaying ? pauseAudio() : playAudio(); });

// Playlist 5 tracks
const tracks=['trungthu.mp3','trungthu1.mp3','trungthu2.mp3','trungthu3.mp3','trungthu4.mp3'];
let trackIndex = 0;
function updateTrack(){ $('#trackName').textContent = tracks[trackIndex].replace('.mp3',''); }
function setTrack(i){ trackIndex=(i+tracks.length)%tracks.length; audio.src = tracks[trackIndex]; if(isPlaying){ audio.currentTime=0; audio.play().catch(()=>{}); } updateTrack(); }
$('#btnSong').onclick = ()=>{ setTrack(trackIndex+1); toast('ƒê·ªïi nh·∫°c: '+tracks[trackIndex].replace('.mp3','')); };
audio.addEventListener('ended', ()=> setTrack(trackIndex+1));
updateTrack();

// Overlay start (for autoplay policies)
$('#startBtn').onclick = async ()=>{ await playAudio(); $('#overlay').style.display='none'; sparkle(); };
$('#skipBtn').onclick = ()=>{ $('#overlay').style.display='none'; };

// ===== Fireworks (foreground) =====
const fx = $('#fx'); const ctx = fx.getContext('2d');
// ===== Fireworks (background / remote) =====
const fxBack = $('#fxBack'); const ctxB = fxBack.getContext('2d');

function resize(){ fx.width = innerWidth*devicePixelRatio; fx.height = innerHeight*devicePixelRatio; fxBack.width = innerWidth*devicePixelRatio; fxBack.height = innerHeight*devicePixelRatio; }
addEventListener('resize', resize); resize();

// Foreground particles
const particles=[];
function spawn(x,y,color,count=140){ count = Math.floor(count * (isMobile ? 0.6 : 1));
  for(let i=0;i<count;i++){
    const a=Math.random()*Math.PI*2; const s=Math.random()*4+1.6;
    particles.push({x:x*devicePixelRatio,y:y*devicePixelRatio,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:120+Math.random()*160,color});
  }
}
function sparkle(){ spawn(innerWidth*0.5, innerHeight*0.35, `hsl(${Math.random()*360},100%,70%)`, isMobile?50:80); }
function loop(){
  ctx.globalCompositeOperation='destination-out';
  ctx.fillStyle='rgba(0,0,0,0.12)';
  ctx.fillRect(0,0,fx.width,fx.height);
  ctx.globalCompositeOperation='lighter';
  for(const p of particles){ p.x+=p.vx; p.y+=p.vy; p.vy+=0.01; p.life-=1; ctx.beginPath(); ctx.arc(p.x,p.y, 2*devicePixelRatio, 0, Math.PI*2); ctx.fillStyle=p.color; ctx.fill(); }
  for(let i=particles.length-1;i>=0;i--){ if(particles[i].life<=0) particles.splice(i,1); }
  requestAnimationFrame(loop);
}
loop();

$('#btnFire').onclick = ()=>{
  for(let i=0;i<3;i++) setTimeout(()=>{ spawn(innerWidth*Math.random(), innerHeight*(.3+.4*Math.random()), `hsl(${Math.random()*360},100%,70%)`, 150); playSfxNear(); }, i*180);
};

// Background (remote) fun shapes
const farParticles=[];
function addFarPoint(cx,cy,px,py,color){ const j=0.6, s=devicePixelRatio; const vx=px*0.02+(Math.random()-0.5)*j; const vy=py*0.02+(Math.random()-0.5)*j; farParticles.push({x:(cx+px)*s,y:(cy+py)*s,vx,vy,life:240+Math.random()*140,color}); }
function spawnShapeBack(shape){
  const cx=innerWidth*(0.2+0.6*Math.random());
  const cy=innerHeight*(0.18+0.22*Math.random());
  const hue=Math.floor(Math.random()*360); const color=`hsl(${hue},100%,70%)`;
  const r=Math.min(innerWidth,innerHeight)*0.08; const N=140;
  if(shape==='ring'){
    for(let i=0;i<N;i++){ const t=i/N*2*Math.PI; addFarPoint(cx,cy,Math.cos(t)*r,Math.sin(t)*r,color); }
  }else if(shape==='star'){
    const spikes=5, r1=r, r2=r*0.45, pts=spikes*2; for(let i=0;i<pts;i++){ const t=i/pts*2*Math.PI; const rr=(i%2===0)?r1:r2; addFarPoint(cx,cy,Math.cos(t)*rr,Math.sin(t)*rr,color); }
  }else if(shape==='heart'){
    for(let i=0;i<N;i++){ const t=i/N*2*Math.PI; const x=16*Math.sin(t)**3; const y=13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t); const s=r/18; addFarPoint(cx,cy,x*s,-y*s,color); }
  }else if(shape==='smiley'){
    for(let i=0;i<N;i++){ const t=i/N*2*Math.PI; addFarPoint(cx,cy,Math.cos(t)*r,Math.sin(t)*r,color); }
    const er=r*0.12, ex=r*0.35, ey=-r*0.2;
    for(let i=0;i<40;i++){ const t=i/40*2*Math.PI; addFarPoint(cx+ex,cy+ey,Math.cos(t)*er,Math.sin(t)*er,color); addFarPoint(cx-ex,cy+ey,Math.cos(t)*er,Math.sin(t)*er,color); }
    for(let i=0;i<70;i++){ const t=(-Math.PI*0.1)+(i/70)*Math.PI*1.2; const rr=r*0.55; addFarPoint(cx,cy+r*0.15,Math.cos(t)*rr,Math.sin(t)*rr,color); }
  }else if(shape==='spiral'){
    const turns=3.2, steps=240, sr=r*0.1, er=r; for(let i=0;i<steps;i++){ const t=i/steps*turns*2*Math.PI; const rr=sr+(er-sr)*(i/steps); addFarPoint(cx,cy,Math.cos(t)*rr,Math.sin(t)*rr,color); }
  }
}
function loopBack(){
  ctxB.globalCompositeOperation='destination-out';
  ctxB.fillStyle='rgba(0,0,0,0.10)';
  ctxB.fillRect(0,0,fxBack.width,fxBack.height);
  ctxB.globalCompositeOperation='lighter';
  for(const p of farParticles){ p.x+=p.vx; p.y+=p.vy; p.vy+=0.004; p.life-=1; ctxB.beginPath(); ctxB.arc(p.x,p.y, 1.8*devicePixelRatio, 0, Math.PI*2); ctxB.fillStyle=p.color; ctxB.fill(); }
  for(let i=farParticles.length-1;i>=0;i--){ if(farParticles[i].life<=0) farParticles.splice(i,1); }
  requestAnimationFrame(loopBack);
}
loopBack();

const shapes=['ring','star','heart','smiley','spiral'];
$('#btnRemote').onclick = ()=>{
  const bursts = 2 + Math.floor(Math.random()*2); // 2-3 shapes
  for(let i=0;i<bursts;i++) setTimeout(()=>{ spawnShapeBack(shapes[Math.floor(Math.random()*shapes.length)]); playSfxFar(); }, i*260);
};

// ===== Stars & Lanterns =====
const sky = $('.stars');
function makeStar(n=120){ for(let i=0;i<n;i++){ const s=document.createElement('i'); s.style.left=(Math.random()*100)+'%'; s.style.top=(Math.random()*100)+'%'; const d=Math.random()*3+1; s.style.opacity=0.6+Math.random()*0.4; s.style.animationDuration=(2.5+Math.random()*2)+'s'; s.style.transform=`scale(${d/2})`; sky.appendChild(s); } }
function makeLanterns(n=10){ for(let i=0;i<n;i++){ const l=document.createElement('div'); l.className='lantern'; l.style.left=(Math.random()*100)+'%'; l.style.animationDuration=(12+Math.random()*8)+'s'; l.style.opacity=0.7+Math.random()*0.3; l.style.filter=`hue-rotate(${Math.floor(Math.random()*60)-30}deg)`; document.body.appendChild(l); } }
makeStar(isMobile?70:120); makeLanterns(isMobile?8:12);
$('#btnLantern').onclick = ()=> makeLanterns(5);

// ===== SFX =====
function clonePlay(el, vol=0.7, ttl=6000){
  try{ const c = el.cloneNode(); c.volume = vol; c.play(); setTimeout(()=>c.remove(), ttl); }catch{}
}
const sfxNear = $('#phao');
const sfxFar = $('#phao1');
function playSfxNear(){ clonePlay(sfxNear, 0.7, 5000); }
function playSfxFar(){ clonePlay(sfxFar, 0.55, 6000); }

// ===== Toast =====
function toast(msg){ const t=document.createElement('div'); t.textContent=msg; Object.assign(t.style,{ position:'fixed', left:'50%', bottom:'30px', transform:'translateX(-50%)', background:'rgba(0,0,0,.7)', color:'#fff', padding:'10px 14px', borderRadius:'999px', zIndex:99, fontWeight:700 }); document.body.appendChild(t); setTimeout(()=>{ t.remove(); }, 1500); }
</script>
</body>
</html>
