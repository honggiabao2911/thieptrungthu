<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Thi·ªáp Trung Thu ‚ú®üåï ‚Äì B·∫£n ho√†n thi·ªán</title>
  <meta name="description" content="Thi·ªáp Trung Thu co gi√£n theo n·ªôi dung, chia s·∫ª b·∫±ng ·∫£nh tr·ª±c ti·∫øp, ƒë√®n l·ªìng r√µ tr√™n ƒëi·ªán tho·∫°i, c√≥ nh·∫°c & ph√°o hoa." />
  <meta name="theme-color" content="#0b1b3a" />
  <meta property="og:title" content="Thi·ªáp Trung Thu c·ªßa b·∫°n" />
  <meta property="og:description" content="M·ªü thi·ªáp ƒë·ªÉ nghe nh·∫°c v√† nh·∫≠n l·ªùi ch√∫c Trung Thu th·∫≠t √Ω nghƒ©a!" />
  <meta property="og:type" content="website" />

  <!-- Preload audio -->
  <link rel="preload" as="audio" href="trungthu.mp3" />
  <link rel="preload" as="audio" href="trungthu1.mp3" />
  <link rel="preload" as="audio" href="trungthu2.mp3" />
  <link rel="preload" as="audio" href="trungthu3.mp3" />
  <link rel="preload" as="audio" href="trungthu4.mp3" />
  <link rel="preload" as="audio" href="phao.mp3" />
  <link rel="preload" as="audio" href="phao1.mp3" />

  <style>
    :root{ --bg1:#0b1b3a; --bg2:#1b335f; --moon:#ffe9a3; --lantern:#ffb84d; --accent:#ffd166; --paper:#fff7e6; --ink:#3b2f1a; --glass: rgba(255,255,255,.08) }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:#f5f7ff;
      background: radial-gradient(1200px 800px at 70% -10%, #254273 0%, transparent 60%), linear-gradient(180deg,var(--bg2),var(--bg1));
      overflow-y:auto}

    .stars{position:fixed; inset:0; pointer-events:none}
    .stars i{position:absolute; width:2.5px; height:2.5px; background:#cfe3ff; opacity:.9; border-radius:50%; animation: twinkle 3.8s infinite ease-in-out}
    @keyframes twinkle{50%{transform:scale(1.6); opacity:.45}}

    .moon{position:absolute; top:4vh; right:6vw; width:128px; height:128px; background:radial-gradient(circle at 30% 30%, #fff7d1 20%, var(--moon) 60%, #f7d77a 100%);
      border-radius:50%; box-shadow:0 0 30px 10px rgba(255,233,163,.35), 0 0 120px rgba(255,233,163,.25)}

    /* ƒê√®n l·ªìng ‚Äì r√µ tr√™n mobile */
    .lantern{position:absolute; bottom:-160px; width:54px; height:78px; background:linear-gradient(180deg, #ffcf70, var(--lantern)); border-radius:14px;
      box-shadow:0 -10px 20px rgba(255,209,102,.35) inset, 0 10px 20px rgba(0,0,0,.28) inset, 0 0 24px rgba(255,184,77,.7);
      animation: floatUp 16s linear infinite; filter: drop-shadow(0 0 16px rgba(255, 200, 120, .95)); mix-blend-mode: screen}
    .lantern::before{content:""; position:absolute; left:50%; top:-18px; width:26px; height:18px; transform:translateX(-50%);
      background:linear-gradient(180deg, #fbe7b8, #ffd166); border-radius:8px 8px 0 0}
    .lantern::after{content:""; position:absolute; left:50%; bottom:-14px; width:24px; height:18px; transform:translateX(-50%);
      background:linear-gradient(180deg, #ffebc6, #ffb84d); border-radius:0 0 8px 8px; box-shadow:0 6px 14px rgba(255,184,77,.9)}
    @keyframes floatUp{0%{transform:translateY(0)}100%{transform:translateY(-120vh)}}

    .wrap{position:relative; z-index:2; min-height:100svh; display:grid; place-items:center; padding:16px calc(16px + env(safe-area-inset-right))}
    .card{width:min(960px,94vw); background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06)); border:1px solid rgba(255,255,255,.18);
      border-radius:24px; box-shadow:0 20px 60px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.2); backdrop-filter:blur(10px); overflow:hidden; margin:10px auto}
    .card-header{display:flex; align-items:center; gap:14px; padding:18px 22px; background:linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.03)); border-bottom:1px solid rgba(255,255,255,.15)}
    .title{font-size:clamp(22px,2.6vw,32px); margin:0; font-weight:800}
    .subtitle{opacity:.85; font-size:clamp(13px,1.4vw,15px)}

    .content{display:grid; grid-template-columns:1.04fr .96fr; gap:18px; padding:22px}
    @media(max-width:860px){.content{grid-template-columns:1fr; gap:14px; padding:14px}}

    .paper{background:var(--paper); color:var(--ink); padding:22px; border-radius:16px; box-shadow:inset 0 2px 0 #fff, 0 10px 24px rgba(0,0,0,.15)}
    .wish{line-height:1.6; font-size:clamp(17px,2vw,20px); min-height:220px}

    .actions{display:flex; flex-wrap:wrap; gap:10px; margin-top:14px}
    button,.ghost{border:0; padding:10px 14px; border-radius:999px; font-weight:700; cursor:pointer; background:#1e293b; color:#e9f1ff;
      border:1px solid rgba(255,255,255,.25); transition:.2s; min-height:44px; touch-action:manipulation}
    button:hover,.ghost:hover{transform:translateY(-1px); box-shadow:0 8px 20px rgba(0,0,0,.25)}
    button.primary{background:linear-gradient(180deg,#ffd166,#ffb84d); color:var(--ink); border-color:#f59f0b}
    .ghost{background:#334155; color:#e9f1ff; border-color:rgba(255,255,255,.55)}
    #btnShare.ghost{background:linear-gradient(180deg,#ffd166,#ffb84d); color:var(--ink); border-color:#f59f0b; box-shadow:0 8px 20px rgba(255,184,77,.4)}

    .greeting{font-weight:800; font-size:clamp(18px,2.2vw,22px); margin:0 0 6px}
    .small{font-size:13px; opacity:.8}

    .editor{margin-top:12px}
    .editor label{display:block; margin:6px 0; font-weight:700; color:var(--ink)}
    .editor textarea{width:100%; min-height:80px; padding:10px; border-radius:12px; border:1px solid rgba(0,0,0,.1); font-family:inherit; font-size:15px; color:var(--ink); background:#fffdf7}

    /* Audio button */
    .audio-toggle{position:fixed; right:18px; bottom:calc(max(18px, env(safe-area-inset-bottom))); z-index:10; width:54px; height:54px; display:grid; place-items:center;
      border-radius:50%; background:var(--glass); border:1px solid rgba(255,255,255,.3); backdrop-filter:blur(8px); cursor:pointer}
    .audio-toggle svg{width:26px; height:26px; fill:#fff}
    .audio-hint{position:fixed; right:18px; bottom:80px; background:var(--glass); border:1px solid rgba(255,255,255,.25); padding:8px 12px; border-radius:10px; font-size:12px}

    .overlay{position:fixed; inset:0; background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.75)); display:grid; place-items:center; z-index:20}
    .overlay .box{width:min(560px,92vw); text-align:center}

    #fxBack{position:fixed; inset:0; pointer-events:none; z-index:1}
    #fx{position:fixed; inset:0; pointer-events:none; z-index:3}

    footer{padding:10px 18px; text-align:center; opacity:.8; font-size:12px; padding-bottom: calc(10px + env(safe-area-inset-bottom));}
    @media (max-width: 600px){
      .paper{ padding:16px }
      .actions{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
      #btnShare{ grid-column:1/-1 }
      .title{ font-size:22px }
      .lantern{ width:70px; height:98px }
    }

    /* Sender box */
    .frombox label{display:block; margin:6px 0 6px; color:var(--ink); font-weight:700}
    .frombox input{width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(0,0,0,.1); font-size:15px; background:#fffdf7; color:var(--ink)}
  </style>
</head>
<body>
  <canvas id="fxBack"></canvas>
  <canvas id="fx"></canvas>
  <div class="stars"></div>
  <div class="moon"></div>

  <div class="wrap">
    <div class="card">
      <div class="card-header">
        <h1 class="title">T·∫øt Trung Thu ‚Äì TrƒÉng tr√≤n ƒëo√†n vi√™n</h1>
        <div class="subtitle">M·ªü thi·ªáp ƒë·ªÉ nghe nh·∫°c v√† nh·∫≠n nh·ªØng l·ªùi ch√∫c √Ω nghƒ©a ‚ú®</div>
      </div>

      <div class="content">
        <section class="paper">
          <p class="greeting" id="greeting"></p>
          <p class="small" id="fromLine"></p>
          <div id="wish" class="wish"><span id="wishText"></span></div>

          <div class="actions">
            <button class="primary" id="btnRandom">Ng·∫´u nhi√™n</button>
            <button id="btnCopy">Sao ch√©p</button>
            <button id="btnSong">ƒê·ªïi nh·∫°c</button>
            <button id="btnDL">T·∫£i ·∫£nh</button>
            <a class="ghost" id="btnShare" href="#">Chia s·∫ª</a>
          </div>

          <div class="frombox">
            <label for="fromInput">T√™n ng∆∞·ªùi g·ª≠i</label>
            <input id="fromInput" type="text" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi g·ª≠i..." />
            <div class="actions" style="margin-top:8px"><button id="btnSaveFrom">L∆∞u t√™n</button></div>
          </div>

          <div class="editor">
            <label for="customInput">T·ª± vi·∫øt l·ªùi ch√∫c</label>
            <textarea id="customInput" placeholder="Nh·∫≠p l·ªùi ch√∫c..."></textarea>
            <div class="actions">
              <button id="btnUse">C·∫≠p nh·∫≠t</button>
              <button id="btnAddWish">Th√™m m·ªõi</button>
              <button class="ghost" id="btnReset">Kh√¥i ph·ª•c</button>
            </div>
          </div>
          <p class="small">Nh·∫°c: <b id="trackName">trungthu</b></p>
        </section>

        <section>
          <div class="paper">
            <h3>√ù nghƒ©a ƒë√™m r·∫±m</h3>
            <p>Trung Thu l√† kho·∫£nh kh·∫Øc c·∫£ nh√† qu√¢y qu·∫ßn d∆∞·ªõi v·∫ßng trƒÉng tr√≤n, nh·∫Øc nhau g√¨n gi·ªØ y√™u th∆∞∆°ng, s·∫ª chia v√† bi·∫øt ∆°n.</p>
            <div class="actions">
              <button id="btnFire">üéá B·∫Øn ph√°o hoa</button>
              <button id="btnRemote">üì° Ph√°o t·∫ßm xa</button>
              <button id="btnLantern">üèÆ Th·∫£ ƒë√®n</button>
            </div>
          </div>
        </section>
      </div>

      <footer>Made with ‚ô• | T·∫°o l·ªùi ch√∫c t·∫°i ƒë√¢y: <span id="baseShow"></span></footer>
    </div>
  </div>

  <!-- Audio -->
  <audio id="bgm" src="trungthu.mp3" preload="auto" loop></audio>
  <audio id="phao" src="phao.mp3" preload="auto"></audio>
  <audio id="phao1" src="phao1.mp3" preload="auto"></audio>

  <button class="audio-toggle" id="audioToggle">
    <svg id="iconPlay" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
    <svg id="iconPause" viewBox="0 0 24 24" style="display:none"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
  </button>
  <div class="audio-hint" id="audioHint" hidden>Nh·∫•n ƒë·ªÉ b·∫≠t nh·∫°c ‚ô´</div>

  <div class="overlay" id="overlay">
    <div class="box paper">
      <h2>Ch√∫c Trung Thu vui v·∫ª! üåï</h2>
      <div class="actions">
        <button class="primary" id="startBtn">B·∫≠t nh·∫°c & b·∫Øt ƒë·∫ßu</button>
        <button class="ghost" id="skipBtn">V√†o xem</button>
      </div>
    </div>
  </div>

  <script>
  // ========= Helpers =========
  const $ = (s, p=document) => p.querySelector(s);
  const $$ = (s, p=document) => [...p.querySelectorAll(s)];
  const isMobile = matchMedia('(max-width: 600px), (pointer: coarse)').matches;

  // ========= Personalize & Base link =========
  const BASE = 'https://honggiabao2911.github.io/thieptrungthu/';
  $('#baseShow').textContent = BASE;
  const params = new URLSearchParams(location.search);
  const toName = decodeURIComponent((params.get('to')||'').replace(/\+/g,' ')).trim();
  let fromName = decodeURIComponent((params.get('from')||'').replace(/\+/g,' ')).trim();
  try{ if(!fromName){ const savedFrom = localStorage.getItem('fromNameUser'); if(savedFrom) fromName = savedFrom; } }catch{}
  $('#greeting').textContent = toName ? `G·ª≠i ${toName},` : 'G·ª≠i b·∫°n,';
  $('#fromLine').textContent = fromName ? `T·ª´: ${fromName}` : '';
  function buildShareUrl(){ const u = new URL(BASE); if(fromName) u.searchParams.set('from', fromName); if(toName) u.searchParams.set('to', toName); return u.toString(); }

  // ========= Wishes =========
  const defaultWishes = [
    'ƒê√™m r·∫±m Trung Thu kh√¥ng ch·ªâ tr√≤n v√† s√°ng, m√† c√≤n nh·∫Øc ta s·ªëng tr·ªçn v·∫πn: tr·ªçn v·ªõi gia ƒë√¨nh, tr·ªçn v·ªõi ∆∞·ªõc m∆°, v√† tr·ªçn v·ªõi ch√≠nh m√¨nh. Ch√∫c b·∫°n m·ªôt m√πa trƒÉng b√¨nh an, n∆°i l√≤ng nh·∫π nh∆∞ m√¢y v√† n·ª• c∆∞·ªùi n·ªü nh∆∞ hoa.',
    '√Ånh trƒÉng t·ªëi nay gi·ªëng nh∆∞ t·∫•m g∆∞∆°ng hi·ªÅn l√†nh soi v√†o tr√°i tim: ƒëi·ªÅu g√¨ t·ªët ƒë·∫πp h√£y gi·ªØ, ƒëi·ªÅu g√¨ n·∫∑ng l√≤ng h√£y ƒë·∫∑t xu·ªëng. Ch√∫c b·∫°n ƒë·ªß tƒ©nh l·∫∑ng ƒë·ªÉ l·∫Øng nghe m√¨nh v√† ƒë·ªß can ƒë·∫£m ƒë·ªÉ b∆∞·ªõc ti·∫øp.',
    'Ch√∫c b·∫°n v√† nh·ªØng ng∆∞·ªùi th√¢n th∆∞∆°ng c√≥ m·ªôt ƒë√™m r·∫±m ·∫•m √°p: c√≥ c√¢u chuy·ªán ƒë·ªÉ k·ªÉ, c√≥ ti·∫øng c∆∞·ªùi ƒë·ªÉ nh·ªõ, c√≥ c√°i n·∫Øm tay ƒë·ªÉ y√™n l√≤ng, v√† c√≥ ∆∞·ªõc nguy·ªán ƒë·ªÉ c√πng nhau ƒëi t·ªõi.',
    'Trung Thu l√† m√πa ƒëo√†n vi√™n, nh∆∞ng n·∫øu b·∫°n ·ªü xa, mong √°nh trƒÉng s·∫Ω l√†m chi·∫øc c·∫ßu n·ªëi nh·ªØng y√™u th∆∞∆°ng. Ch√∫c kho·∫£ng c√°ch ch·ªâ l√†m nh·ªõ th∆∞∆°ng th√™m ng·ªçt, v√† ng√†y g·∫∑p l·∫°i s·∫Ω th·∫≠t g·∫ßn.',
    'M·ªói chi·∫øc b√°nh n∆∞·ªõng d·∫ªo th∆°m l√† l·ªùi nh·∫Øc v·ªÅ s·ª± ƒë·ªß ƒë·∫ßy. Ch√∫c b·∫°n ƒë·ªß s·ª©c kh·ªèe ƒë·ªÉ gieo, ƒë·ªß ki√™n nh·∫´n ƒë·ªÉ ch·ªù, ƒë·ªß ni·ªÅm vui ƒë·ªÉ g·∫∑t, v√† ƒë·ªß bi·∫øt ∆°n ƒë·ªÉ gi·ªØ nh·ªØng g√¨ qu√Ω gi√°.'
  ];
  let wishes; try{ const saved = JSON.parse(localStorage.getItem('wishesUser')||'null'); wishes = Array.isArray(saved) && saved.length ? saved : [...defaultWishes]; }catch{ wishes=[...defaultWishes]; }
  let idx = 0; function render(){ $('#wishText').textContent = wishes[idx]; }
  render();

  // ========= Emoji decoration =========
  function decorate(text){ const pre=['üåï','üèÆ','üéë','‚ú®','ü•Æ']; const suf=['‚ú®','üåï','üèÆ','‚≠êÔ∏è']; const p=pre[Math.floor(Math.random()*pre.length)]; const s=suf[Math.floor(Math.random()*suf.length)]; return p+' '+text+' '+s; }

  // ========= Buttons =========
  $('#btnRandom').onclick = ()=>{ idx=Math.floor(Math.random()*wishes.length); render(); $('#customInput').value = wishes[idx] || ''; };

  // ========= Copy =========
  $('#btnCopy').onclick = async ()=>{ const head = toName?`G·ª≠i ${toName}, `:''; const text = `${head}${decorate(wishes[idx])}\nT·∫°o l·ªùi ch√∫c t·∫°i ƒë√¢y: ${BASE}`; await navigator.clipboard.writeText(text); toast('ƒê√£ sao ch√©p l·ªùi ch√∫c!'); sparkle(); };

  // ========= Download image (n√∫t ri√™ng nh∆∞ b·∫£n b·∫°n demo) =========
  $('#btnDL').onclick = async ()=>{
    const {blob} = await createCardImage({ to: toName||'b·∫°n', from: fromName||'M·ªôt ng∆∞·ªùi b·∫°n', text: decorate(wishes[idx]) });
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='thiep-trung-thu.png'; document.body.appendChild(a); a.click(); a.remove();
    toast('ƒê√£ t·∫°o & t·∫£i ·∫£nh thi·ªáp');
  };

  // ========= Share as IMAGE (d√πng ƒë√∫ng ƒëo·∫°n b·∫°n ƒë√£ test OK) =========
  $('#btnShare').onclick = async (e)=>{
    e.preventDefault();
    const {blob} = await createCardImage({ to: toName||'b·∫°n', from: fromName||'M·ªôt ng∆∞·ªùi b·∫°n', text: decorate(wishes[idx]) });
    const file = new File([blob], 'thiep-trung-thu.png', {type:'image/png'});
    const caption = `T·∫°o l·ªùi ch√∫c t·∫°i ƒë√¢y: ${BASE}`;
    try{
      if(navigator.canShare && navigator.canShare({ files:[file] })){
        await navigator.share({ files:[file], title:'Thi·ªáp Trung Thu', text: caption });
        toast('ƒê√£ m·ªü chia s·∫ª b·∫±ng ·∫£nh');
      } else {
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='thiep-trung-thu.png'; document.body.appendChild(a); a.click(); a.remove();
        toast('Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ chia s·∫ª ·∫£nh tr·ª±c ti·∫øp ‚Äî ƒë√£ t·∫£i ·∫£nh ƒë·ªÉ b·∫°n g·ª≠i qua Zalo/FB.');
      }
    }catch(err){
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='thiep-trung-thu.png'; document.body.appendChild(a); a.click(); a.remove();
    }
  };

  // ========= Save sender name =========
  const fromInput = $('#fromInput'); if(fromInput){ fromInput.value = fromName || ''; }
  $('#btnSaveFrom').onclick = ()=>{ fromName = (fromInput.value||'').trim() || fromName; try{ localStorage.setItem('fromNameUser', fromName); }catch{} $('#fromLine').textContent = fromName?`T·ª´: ${fromName}`:''; toast('ƒê√£ l∆∞u t√™n ng∆∞·ªùi g·ª≠i'); };
  fromInput?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('#btnSaveFrom').click(); } });

  // ========= Custom wish editor =========
  const customInput = $('#customInput'); customInput.value = wishes[idx] || '';
  function saveWishes(clear=false){ try{ clear ? localStorage.removeItem('wishesUser') : localStorage.setItem('wishesUser', JSON.stringify(wishes)); }catch{} }
  $('#btnUse').onclick = ()=>{ const t = (customInput.value||'').trim(); if(!t){ toast('Nh·∫≠p l·ªùi ch√∫c tr∆∞·ªõc nh√©'); return; } wishes[idx] = t; saveWishes(); render(); sparkle(); toast('ƒê√£ c·∫≠p nh·∫≠t l·ªùi ch√∫c'); };
  $('#btnAddWish').onclick = ()=>{ const t = (customInput.value||'').trim(); if(!t){ toast('Nh·∫≠p l·ªùi ch√∫c tr∆∞·ªõc nh√©'); return; } wishes.push(t); idx = wishes.length - 1; saveWishes(); render(); sparkle(); toast('ƒê√£ th√™m v√†o danh s√°ch'); };
  $('#btnReset').onclick = ()=>{ if(confirm('Kh√¥i ph·ª•c danh s√°ch l·ªùi ch√∫c g·ªëc?')){ wishes=[...defaultWishes]; idx=0; saveWishes(true); render(); toast('ƒê√£ kh√¥i ph·ª•c danh s√°ch g·ªëc'); } };

  // ========= Audio =========
  const audio = $('#bgm');
  const sfxFire = $('#phao');     // ph√°o b√¥ng g·∫ßn
  const sfxRemote = $('#phao1');  // ph√°o t·∫ßm xa

  const toggleBtn = $('#audioToggle');
  const iconPlay=$('#iconPlay'); const iconPause=$('#iconPause');
  let isPlaying=false;

  // Playlist c√≥ trungthu4
  const tracks = ['trungthu.mp3','trungthu1.mp3','trungthu2.mp3','trungthu3.mp3','trungthu4.mp3'];
  let trackIndex = 0;

  function updateTrackName(){ $('#trackName').textContent = tracks[trackIndex].replace('.mp3',''); }
  function updateAudioUI(){ iconPlay.style.display = isPlaying?'none':'block'; iconPause.style.display = isPlaying?'block':'none'; }

  async function playAudio(){
    try{
      await audio.play();
      isPlaying=true; updateAudioUI();
    }catch{
      $('#audioHint').hidden=false;
    }
  }
  function pauseAudio(){ audio.pause(); isPlaying=false; updateAudioUI(); }

  // ƒê·ªïi b√†i g·ªçn gi·ªëng b·∫£n b·∫°n ƒë∆∞a
  function setTrack(i){
    trackIndex = (i + tracks.length) % tracks.length;
    audio.src = tracks[trackIndex];
    if(isPlaying){
      audio.currentTime = 0;
      audio.play().catch(()=>{});
    }
    updateTrackName();
  }
  $('#btnSong').onclick = ()=>{ setTrack(trackIndex + 1); toast('ƒê·ªïi nh·∫°c: '+tracks[trackIndex].replace('.mp3','')); sparkle(); };
  audio.addEventListener('ended', ()=> setTrack(trackIndex+1));
  toggleBtn.onclick = ()=>{ isPlaying ? pauseAudio() : playAudio(); };
  updateTrackName();

  // Overlay
  $('#startBtn').onclick = async ()=>{ await playAudio(); $('#overlay').style.display='none'; sparkle(); };
  $('#skipBtn').onclick = ()=>{ $('#overlay').style.display='none'; };

  // ========= Hi·ªáu ·ª©ng ph√°o s√°ng =========
  const fx = $('#fx'); const ctx = fx.getContext('2d'); const fxBack = $('#fxBack'); const ctxB = fxBack.getContext('2d');
  function resize(){ fx.width = innerWidth*devicePixelRatio; fx.height = innerHeight*devicePixelRatio; fxBack.width = innerWidth*devicePixelRatio; fxBack.height = innerHeight*devicePixelRatio; }
  addEventListener('resize', resize); resize();

  const MOBILE_BOOST = isMobile ? 0.8 : 1;
  const particles=[];
  function spawn(x,y,color,count=140){ count=Math.floor(count*(MOBILE_BOOST)); for(let i=0;i<count;i++){ const a=Math.random()*Math.PI*2; const s=Math.random()*4+1.6; particles.push({x:x*devicePixelRatio,y:y*devicePixelRatio,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:120+Math.random()*160,color}); } }
  function sparkle(){ const col='hsl('+ (Math.random()*360) +',100%,70%)'; spawn(innerWidth*0.5, innerHeight*0.35, col, isMobile?60:90); }
  function loop(){ ctx.globalCompositeOperation='destination-out'; ctx.fillStyle='rgba(0,0,0,0.12)'; ctx.fillRect(0,0,fx.width,fx.height); ctx.globalCompositeOperation='lighter'; for(const p of particles){ p.x+=p.vx; p.y+=p.vy; p.vy+=0.01; p.life-=1; ctx.beginPath(); ctx.arc(p.x,p.y, 2*devicePixelRatio, 0, Math.PI*2); ctx.fillStyle=p.color; ctx.fill(); } for(let i=particles.length-1;i>=0;i--){ if(particles[i].life<=0) particles.splice(i,1); } requestAnimationFrame(loop); } loop();

  // N√∫t ph√°o + √¢m thanh (clone ƒë·ªÉ b·∫•m li√™n t·ª•c)
  function clonePlay(el, vol=0.8, ttl=6000){ try{ const c=el.cloneNode(); c.volume=vol; c.play(); setTimeout(()=>c.remove(), ttl); }catch{} }
  $('#btnFire').onclick = ()=>{ for(let i=0;i<3;i++) setTimeout(()=>{ const col='hsl('+ (Math.random()*360) +',100%,70%)'; spawn(innerWidth*Math.random(), innerHeight*(.3+.4*Math.random()), col, 150); clonePlay(sfxFire,0.75,4500); }, i*180); };

  // ===== Background soft effects (cho "ph√°o t·∫ßm xa") =====
  const farParticles=[];
  function addFarPoint(cx,cy,px,py,color){ const j=0.6,s=devicePixelRatio; const vx=px*0.02+(Math.random()-0.5)*j; const vy=py*0.02+(Math.random()-0.5)*j; farParticles.push({x:(cx+px)*s,y:(cy+py)*s,vx,vy,life:240+Math.random()*140,color}); }
  function spawnShapeBack(shape){
    const cx=innerWidth*(0.2+0.6*Math.random());
    const cy=innerHeight*(0.18+0.22*Math.random());
    const hue=Math.floor(Math.random()*360); const color='hsl('+hue+',100%,70%)';
    const r=Math.min(innerWidth,innerHeight)*0.08; const N=140;
    if(shape==='ring'){ for(let i=0;i<N;i++){ const t=i/N*2*Math.PI; addFarPoint(cx,cy,Math.cos(t)*r,Math.sin(t)*r,color); } }
    else if(shape==='star'){ const spikes=5,r1=r,r2=r*0.45,pts=spikes*2; for(let i=0;i<pts;i++){ const t=i/pts*2*Math.PI; const rr=(i%2===0)?r1:r2; addFarPoint(cx,cy,Math.cos(t)*rr,Math.sin(t)*rr,color); } }
    else if(shape==='heart'){ for(let i=0;i<N;i++){ const t=i/N*2*Math.PI; const x=16*Math.sin(t)**3; const y=13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t); const s=r/18; addFarPoint(cx,cy,x*s,-y*s,color); } }
    else if(shape==='spiral'){ const turns=3.2,steps=240,sr=r*0.1,er=r; for(let i=0;i<steps;i++){ const t=i/steps*turns*2*Math.PI; const rr=sr+(er-sr)*(i/steps); addFarPoint(cx,cy,Math.cos(t)*rr,Math.sin(t)*rr,color); } }
  }
  function loopBack(){
    ctxB.globalCompositeOperation='destination-out'; ctxB.fillStyle='rgba(0,0,0,0.10)'; ctxB.fillRect(0,0,fxBack.width,fxBack.height);
    ctxB.globalCompositeOperation='lighter';
    for(const p of farParticles){ p.x+=p.vx; p.y+=p.vy; p.vy+=0.004; p.life-=1; ctxB.beginPath(); ctxB.arc(p.x,p.y, 1.8*devicePixelRatio, 0, Math.PI*2); ctxB.fillStyle=p.color; ctxB.fill(); }
    for(let i=farParticles.length-1;i>=0;i--){ if(farParticles[i].life<=0) farParticles.splice(i,1); }
    requestAnimationFrame(loopBack);
  } loopBack();

  const shapes=['ring','star','heart','spiral'];
  $('#btnRemote').onclick = ()=>{ const bursts=2+Math.floor(Math.random()*2); for(let i=0;i<bursts;i++) setTimeout(()=>{ spawnShapeBack(shapes[Math.floor(Math.random()*shapes.length)]); clonePlay(sfxRemote,0.6,6000); }, i*260); };

  // Stars & lanterns
  const sky = $('.stars');
  function makeStar(n=120){ for(let i=0;i<n;i++){ const s=document.createElement('i'); s.style.left=(Math.random()*100)+'%'; s.style.top=(Math.random()*100)+'%'; const d=1+Math.random()*3; s.style.opacity=0.6+Math.random()*0.4; s.style.animationDuration=(2.5+Math.random()*2)+'s'; s.style.transform='scale('+(d/1.6)+')'; sky.appendChild(s); } }
  function makeLanterns(n=10){ for(let i=0;i<n;i++){ const l=document.createElement('div'); l.className='lantern'; l.style.left=(Math.random()*100)+'%'; l.style.animationDuration=(12+Math.random()*8)+'s'; l.style.opacity=0.85; document.body.appendChild(l); } }
  makeStar(isMobile?90:120); makeLanterns(isMobile?10:12);
  $('#btnLantern').onclick = ()=> makeLanterns(6);

  // ========= Card image generator (co gi√£n theo n·ªôi dung) =========
  function roundRect(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
  function wrapLines(ctx, text, maxWidth){
    const words = text.split(' '); const lines = []; let line = '';
    for(let n=0;n<words.length;n++){
      const test = line + words[n] + ' ';
      if(ctx.measureText(test).width > maxWidth && line){ lines.push(line.trim()); line = words[n] + ' '; }
      else line = test;
    }
    lines.push(line.trim()); return lines;
  }

  async function createCardImage({to, from, text}){
    const W = 1080, P = 80;
    const ctmp = document.createElement('canvas').getContext('2d');
    ctmp.font = '400 34px sans-serif';
    const cardW = W - P*2;
    const contentLines = wrapLines(ctmp, text, cardW-56);
    const lineHeight = 50;
    const fixedTop = 210, fixedBottom = 120;
    const MIN_CARD_H = 380;
    let cardH = Math.max(MIN_CARD_H, fixedTop + contentLines.length*lineHeight + fixedBottom);
    const H = cardH + 260 + 120;

    const canvas = document.createElement('canvas'); canvas.width=W; canvas.height=H; const c=canvas.getContext('2d');

    const g=c.createLinearGradient(0,0,0,H); g.addColorStop(0,'#0b1b3a'); g.addColorStop(1,'#1b335f'); c.fillStyle=g; c.fillRect(0,0,W,H);
    c.save(); c.shadowColor='rgba(255,233,163,.5)'; c.shadowBlur=70; c.fillStyle='#ffe9a3'; c.beginPath(); c.arc(W*0.82,180,88,0,Math.PI*2); c.fill(); c.restore();

    function lantern(x,y,s,color){ c.save(); c.translate(x,y); c.scale(s,s); c.fillStyle=color; c.shadowColor=color; c.shadowBlur=40; roundRect(c,-30,-45,60,90,16); c.fill(); c.restore(); }
    lantern(160,160,1.0,'#ffcf70'); lantern(260,280,0.85,'#ffd166'); lantern(W-220,240,0.9,'#ffc35a');

    const cardX=P, cardY=260;
    c.save(); c.shadowColor='rgba(0,0,0,.25)'; c.shadowBlur=28; c.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--paper') || '#fff7e6';
    roundRect(c, cardX, cardY, cardW, cardH, 28); c.fill(); c.restore();
    c.lineWidth=2; c.strokeStyle='#ffd166'; roundRect(c, cardX, cardY, cardW, cardH, 28); c.stroke();

    c.fillStyle='#3b2f1a'; c.font='700 42px sans-serif'; c.fillText('Thi·ªáp Trung Thu', cardX+28, cardY+90);
    c.font='700 36px sans-serif'; c.fillText('G·ª≠i ' + (to||'b·∫°n') + ',', cardX+28, cardY+150);

    c.font='400 34px sans-serif';
    let y = cardY + fixedTop;
    for(const ln of contentLines){ c.fillText(ln, cardX+28, y); y += lineHeight; }

    c.font='500 30px sans-serif'; c.fillText('T·ª´: ' + (from||'M·ªôt ng∆∞·ªùi b·∫°n'), cardX+28, y+30);
    c.globalAlpha=0.9; c.font='400 26px sans-serif'; c.fillText('T·∫°o l·ªùi ch√∫c t·∫°i ƒë√¢y: ' + BASE, cardX+28, cardY+cardH-32); c.globalAlpha=1;

    return new Promise((resolve)=> canvas.toBlob((blob)=> resolve({blob}), 'image/png'));
  }

  // ===== Toast =====
  function toast(msg){ const t=document.createElement('div'); t.textContent=msg; Object.assign(t.style,{ position:'fixed', left:'50%', bottom:'30px', transform:'translateX(-50%)', background:'rgba(0,0,0,.7)', color:'#fff', padding:'10px 14px', borderRadius:'999px', zIndex:99, fontWeight:700 }); document.body.appendChild(t); setTimeout(()=>{ t.remove(); }, 1500); }
  </script>
</body>
</html>
