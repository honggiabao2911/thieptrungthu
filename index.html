<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Thi·ªáp Trung Thu ‚ú®üåï ‚Äì B·∫£n ho√†n thi·ªán</title>
  <meta name="description" content="Thi·ªáp Trung Thu co gi√£n theo n·ªôi dung, chia s·∫ª b·∫±ng ·∫£nh tr·ª±c ti·∫øp, ƒë√®n l·ªìng r√µ tr√™n ƒëi·ªán tho·∫°i, c√≥ nh·∫°c & ph√°o hoa." />
  <meta name="theme-color" content="#0b1b3a" />

  <!-- Preload audio -->
  <link rel="preload" as="audio" href="trungthu.mp3" />
  <link rel="preload" as="audio" href="trungthu1.mp3" />
  <link rel="preload" as="audio" href="trungthu2.mp3" />
  <link rel="preload" as="audio" href="trungthu3.mp3" />
  <link rel="preload" as="audio" href="trungthu4.mp3" />
  <link rel="preload" as="audio" href="phao.mp3" />
  <link rel="preload" as="audio" href="phao1.mp3" />

  <style>
    :root{ --bg1:#0b1b3a; --bg2:#1b335f; --moon:#ffe9a3; --lantern:#ffb84d; --accent:#ffd166; --paper:#fff7e6; --ink:#3b2f1a; --glass: rgba(255,255,255,.08) }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:#f5f7ff;
      background: radial-gradient(1200px 800px at 70% -10%, #254273 0%, transparent 60%), linear-gradient(180deg,var(--bg2),var(--bg1));
      overflow-y:auto}
    .stars{position:fixed; inset:0; pointer-events:none}
    .stars i{position:absolute; width:2.5px; height:2.5px; background:#cfe3ff; opacity:.9; border-radius:50%; animation: twinkle 3.8s infinite ease-in-out}
    @keyframes twinkle{50%{transform:scale(1.6); opacity:.45}}
    .moon{position:absolute; top:4vh; right:6vw; width:128px; height:128px; background:radial-gradient(circle at 30% 30%, #fff7d1 20%, var(--moon) 60%, #f7d77a 100%);
      border-radius:50%; box-shadow:0 0 30px 10px rgba(255,233,163,.35), 0 0 120px rgba(255,233,163,.25)}
    .lantern{position:absolute; bottom:-160px; width:54px; height:78px; background:linear-gradient(180deg, #ffcf70, var(--lantern)); border-radius:14px;
      box-shadow:0 -10px 20px rgba(255,209,102,.35) inset, 0 10px 20px rgba(0,0,0,.28) inset, 0 0 24px rgba(255,184,77,.7);
      animation: floatUp 16s linear infinite; filter: drop-shadow(0 0 16px rgba(255, 200, 120, .95)); mix-blend-mode: screen}
    .lantern::before{content:""; position:absolute; left:50%; top:-18px; width:26px; height:18px; transform:translateX(-50%);
      background:linear-gradient(180deg, #fbe7b8, #ffd166); border-radius:8px 8px 0 0}
    .lantern::after{content:""; position:absolute; left:50%; bottom:-14px; width:24px; height:18px; transform:translateX(-50%);
      background:linear-gradient(180deg, #ffebc6, #ffb84d); border-radius:0 0 8px 8px; box-shadow:0 6px 14px rgba(255,184,77,.9)}
    @keyframes floatUp{0%{transform:translateY(0)}100%{transform:translateY(-120vh)}}
    .wrap{position:relative; z-index:2; min-height:100svh; display:grid; place-items:center; padding:16px calc(16px + env(safe-area-inset-right))}
    .card{width:min(960px,94vw); background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06)); border:1px solid rgba(255,255,255,.18);
      border-radius:24px; box-shadow:0 20px 60px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.2); backdrop-filter:blur(10px); overflow:hidden; margin:10px auto}
    .card-header{display:flex; align-items:center; gap:14px; padding:18px 22px; background:linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.03)); border-bottom:1px solid rgba(255,255,255,.15)}
    .title{font-size:clamp(22px,2.6vw,32px); margin:0; font-weight:800}
    .subtitle{opacity:.85; font-size:clamp(13px,1.4vw,15px)}
    .content{display:grid; grid-template-columns:1.04fr .96fr; gap:18px; padding:22px}
    @media(max-width:860px){.content{grid-template-columns:1fr; gap:14px; padding:14px}}
    .paper{background:var(--paper); color:var(--ink); padding:20px; border-radius:16px; box-shadow:inset 0 2px 0 #fff, 0 10px 24px rgba(0,0,0,.15)}
    .wish{line-height:1.6; font-size:clamp(17px,2vw,20px)}
    .actions{display:flex; flex-wrap:wrap; gap:10px; margin-top:14px}
    button,.ghost{border:0; padding:10px 14px; border-radius:999px; font-weight:700; cursor:pointer; background:#1e293b; color:#e9f1ff;
      border:1px solid rgba(255,255,255,.25); transition:.2s; min-height:44px; touch-action:manipulation}
    button:hover,.ghost:hover{transform:translateY(-1px); box-shadow:0 8px 20px rgba(0,0,0,.25)}
    button.primary{background:linear-gradient(180deg,#ffd166,#ffb84d); color:var(--ink); border-color:#f59f0b}
    .ghost{background:#334155; color:#e9f1ff; border-color:rgba(255,255,255,.55)}
    #btnShare.ghost{background:linear-gradient(180deg,#ffd166,#ffb84d); color:var(--ink); border-color:#f59f0b; box-shadow:0 8px 20px rgba(255,184,77,.4)}
    .greeting{font-weight:800; font-size:clamp(18px,2.2vw,22px); margin:0 0 6px}
    .small{font-size:13px; opacity:.8}
    .editor{margin-top:12px}
    .editor label{display:block; margin:6px 0; font-weight:700; color:var(--ink)}
    .editor textarea{width:100%; min-height:80px; padding:10px; border-radius:12px; border:1px solid rgba(0,0,0,.1); font-family:inherit; font-size:15px; color:var(--ink); background:#fffdf7}
    .frombox label{display:block; margin:6px 0 6px; color:var(--ink); font-weight:700}
    .frombox input{width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(0,0,0,.1); font-size:15px; background:#fffdf7; color:var(--ink)}
    .audio-toggle{position:fixed; right:18px; bottom:calc(max(18px, env(safe-area-inset-bottom))); z-index:10; width:54px; height:54px; display:grid; place-items:center;
      border-radius:50%; background:var(--glass); border:1px solid rgba(255,255,255,.3); backdrop-filter:blur(8px); cursor:pointer}
    .audio-toggle svg{width:26px; height:26px; fill:#fff}
    .audio-hint{position:fixed; right:18px; bottom:80px; background:var(--glass); border:1px solid rgba(255,255,255,.25); padding:8px 12px; border-radius:10px; font-size:12px}
    .overlay{position:fixed; inset:0; background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.75)); display:grid; place-items:center; z-index:20}
    .overlay .box{width:min(560px,92vw); text-align:center}
    #fxBack{position:fixed; inset:0; pointer-events:none; z-index:1}
    #fx{position:fixed; inset:0; pointer-events:none; z-index:3}
    footer{padding:10px 18px; text-align:center; opacity:.8; font-size:12px; padding-bottom: calc(10px + env(safe-area-inset-bottom));}
    @media (max-width: 600px){
      .paper{ padding:16px }
      .actions{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
      #btnShare{ grid-column:1/-1 }
      .title{ font-size:22px }
      .lantern{ width:70px; height:98px }
    }
  </style>
</head>
<body>
  <canvas id="fxBack"></canvas>
  <canvas id="fx"></canvas>
  <div class="stars"></div>
  <div class="moon"></div>

  <div class="wrap">
    <div class="card">
      <div class="card-header">
        <h1 class="title">T·∫øt Trung Thu ‚Äì TrƒÉng tr√≤n ƒëo√†n vi√™n</h1>
        <div class="subtitle">M·ªü thi·ªáp ƒë·ªÉ nghe nh·∫°c v√† nh·∫≠n nh·ªØng l·ªùi ch√∫c √Ω nghƒ©a ‚ú®</div>
      </div>

      <div class="content">
        <section class="paper">
          <p class="greeting" id="greeting"></p>
          <p class="small" id="fromLine"></p>
          <div id="wish" class="wish"><span id="wishText"></span></div>

          <div class="actions">
            <button class="primary" id="btnRandom">Ng·∫´u nhi√™n</button>
            <button id="btnCopy">Sao ch√©p</button>
            <button id="btnSong">ƒê·ªïi nh·∫°c</button>
            <a class="ghost" id="btnShare" href="#">Chia s·∫ª</a>
          </div>

          <div class="frombox">
            <label for="fromInput">T√™n ng∆∞·ªùi g·ª≠i</label>
            <input id="fromInput" type="text" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi g·ª≠i..." />
            <div class="actions" style="margin-top:8px"><button id="btnSaveFrom">L∆∞u t√™n</button></div>
          </div>

          <div class="editor">
            <label for="customInput">T·ª± vi·∫øt l·ªùi ch√∫c</label>
            <textarea id="customInput" placeholder="Nh·∫≠p l·ªùi ch√∫c..."></textarea>
            <div class="actions">
              <button id="btnUse">C·∫≠p nh·∫≠t</button>
              <button id="btnAddWish">Th√™m m·ªõi</button>
              <button class="ghost" id="btnReset">Kh√¥i ph·ª•c</button>
            </div>
          </div>
          <p class="small">Nh·∫°c: <b id="trackName">trungthu</b></p>
        </section>

        <section>
          <div class="paper">
            <h3>√ù nghƒ©a ƒë√™m r·∫±m</h3>
            <p>Trung Thu l√† kho·∫£nh kh·∫Øc c·∫£ nh√† qu√¢y qu·∫ßn d∆∞·ªõi v·∫ßng trƒÉng tr√≤n, nh·∫Øc nhau g√¨n gi·ªØ y√™u th∆∞∆°ng, s·∫ª chia v√† bi·∫øt ∆°n.</p>
            <div class="actions">
              <button id="btnFire">üéá B·∫Øn ph√°o hoa</button>
              <button id="btnRemote">üì° Ph√°o t·∫ßm xa</button>
              <button id="btnLantern">üèÆ Th·∫£ ƒë√®n</button>
            </div>
          </div>
        </section>
      </div>

      <footer>Made with ‚ô• | T·∫°o l·ªùi ch√∫c t·∫°i ƒë√¢y: <span id="baseShow"></span></footer>
    </div>
  </div>

  <!-- Audio -->
  <audio id="bgm" src="trungthu.mp3" preload="auto" loop></audio>
  <!-- phao: ph√°o b√¥ng g·∫ßn -->
  <audio id="phao" src="phao.mp3" preload="auto"></audio>
  <!-- phao1: ph√°o t·∫ßm xa -->
  <audio id="phao1" src="phao1.mp3" preload="auto"></audio>

  <button class="audio-toggle" id="audioToggle">
    <svg id="iconPlay" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
    <svg id="iconPause" viewBox="0 0 24 24" style="display:none"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
  </button>
  <div class="audio-hint" id="audioHint" hidden>Nh·∫•n ƒë·ªÉ b·∫≠t nh·∫°c ‚ô´</div>

  <div class="overlay" id="overlay">
    <div class="box paper">
      <h2>Ch√∫c Trung Thu vui v·∫ª! üåï</h2>
      <div class="actions">
        <button class="primary" id="startBtn">B·∫≠t nh·∫°c & b·∫Øt ƒë·∫ßu</button>
        <button class="ghost" id="skipBtn">V√†o xem</button>
      </div>
    </div>
  </div>

  <script>
  // ========= Helpers =========
  const $ = (s, p=document) => p.querySelector(s);
  const $$ = (s, p=document) => [...p.querySelectorAll(s)];
  const isMobile = matchMedia('(max-width: 600px), (pointer: coarse)').matches;

  // ========= Personalize & Base link =========
  const BASE = 'https://honggiabao2911.github.io/thieptrungthu/';
  $('#baseShow').textContent = BASE;
  const params = new URLSearchParams(location.search);
  const toName = decodeURIComponent((params.get('to')||'').replace(/\+/g,' ')).trim();
  let fromName = decodeURIComponent((params.get('from')||'').replace(/\+/g,' ')).trim();
  try{ if(!fromName){ const savedFrom = localStorage.getItem('fromNameUser'); if(savedFrom) fromName = savedFrom; } }catch{}
  $('#greeting').textContent = toName ? `G·ª≠i ${toName},` : 'G·ª≠i b·∫°n,';
  $('#fromLine').textContent = fromName ? `T·ª´: ${fromName}` : '';
  function buildShareUrl(){ const u = new URL(BASE); if(fromName) u.searchParams.set('from', fromName); if(toName) u.searchParams.set('to', toName); return u.toString(); }

  // ========= Wishes =========
  const defaultWishes = [
    'ƒê√™m r·∫±m Trung Thu kh√¥ng ch·ªâ tr√≤n v√† s√°ng, m√† c√≤n nh·∫Øc ta s·ªëng tr·ªçn v·∫πn: tr·ªçn v·ªõi gia ƒë√¨nh, tr·ªçn v·ªõi ∆∞·ªõc m∆°, v√† tr·ªçn v·ªõi ch√≠nh m√¨nh. Ch√∫c b·∫°n m·ªôt m√πa trƒÉng b√¨nh an, n∆°i l√≤ng nh·∫π nh∆∞ m√¢y v√† n·ª• c∆∞·ªùi n·ªü nh∆∞ hoa.',
    '√Ånh trƒÉng t·ªëi nay gi·ªëng nh∆∞ t·∫•m g∆∞∆°ng hi·ªÅn l√†nh soi v√†o tr√°i tim: ƒëi·ªÅu g√¨ t·ªët ƒë·∫πp h√£y gi·ªØ, ƒëi·ªÅu g√¨ n·∫∑ng l√≤ng h√£y ƒë·∫∑t xu·ªëng. Ch√∫c b·∫°n ƒë·ªß tƒ©nh l·∫∑ng ƒë·ªÉ l·∫Øng nghe m√¨nh v√† ƒë·ªß can ƒë·∫£m ƒë·ªÉ b∆∞·ªõc ti·∫øp.',
    'Ch√∫c b·∫°n v√† nh·ªØng ng∆∞·ªùi th√¢n th∆∞∆°ng c√≥ m·ªôt ƒë√™m r·∫±m ·∫•m √°p: c√≥ c√¢u chuy·ªán ƒë·ªÉ k·ªÉ, c√≥ ti·∫øng c∆∞·ªùi ƒë·ªÉ nh·ªõ, c√≥ c√°i n·∫Øm tay ƒë·ªÉ y√™n l√≤ng, v√† c√≥ ∆∞·ªõc nguy·ªán ƒë·ªÉ c√πng nhau ƒëi t·ªõi.'
  ];
  let wishes; try{ const saved = JSON.parse(localStorage.getItem('wishesUser')||'null'); wishes = Array.isArray(saved) && saved.length ? saved : [...defaultWishes]; }catch{ wishes=[...defaultWishes]; }
  let idx = 0; function render(){ $('#wishText').textContent = wishes[idx]; }
  render();

  // ========= Emoji decoration =========
  function decorate(text){ const pre=['üåï','üèÆ','üéë','‚ú®','ü•Æ']; const suf=['‚ú®','üåï','üèÆ','‚≠êÔ∏è']; const p=pre[Math.floor(Math.random()*pre.length)]; const s=suf[Math.floor(Math.random()*suf.length)]; return p+' '+text+' '+s; }

  // ========= Buttons =========
  $('#btnRandom').onclick = ()=>{ idx=Math.floor(Math.random()*wishes.length); render(); $('#customInput').value = wishes[idx] || ''; };

  // ========= Copy =========
  $('#btnCopy').onclick = async ()=>{ const head = toName?`G·ª≠i ${toName}, `:''; const text = `${head}${decorate(wishes[idx])}\nT·∫°o l·ªùi ch√∫c t·∫°i ƒë√¢y: ${BASE}`; await navigator.clipboard.writeText(text); toast('ƒê√£ sao ch√©p l·ªùi ch√∫c!'); sparkle(); };

  // ========= Share as IMAGE (ƒëa d·ª± ph√≤ng) =========
  $('#btnShare').onclick = async (e)=>{
    e.preventDefault();
    const {blob} = await createCardImage({ to: toName||'b·∫°n', from: fromName||'M·ªôt ng∆∞·ªùi b·∫°n', text: decorate(wishes[idx]) });
    const file = new File([blob], 'thiep-trung-thu.png', {type:'image/png'});
    const caption = `T·∫°o l·ªùi ch√∫c t·∫°i ƒë√¢y: ${BASE}`;

    // 1) Web Share Level 2 (chia s·∫ª file)
    try{
      if(navigator.canShare && navigator.canShare({ files:[file] })){
        await navigator.share({ files:[file], title:'Thi·ªáp Trung Thu', text: caption });
        toast('ƒê√£ m·ªü chia s·∫ª b·∫±ng ·∫£nh');
        return;
      }
    }catch{}

    // 2) Web Share th∆∞·ªùng v·ªõi data URL (nhi·ªÅu tr√¨nh duy·ªát di ƒë·ªông h·ªó tr·ª£)
    try{
      const dataUrl = await new Promise(res=>{
        const r = new FileReader(); r.onload = ()=>res(r.result); r.readAsDataURL(blob);
      });
      if(navigator.share){
        await navigator.share({ title:'Thi·ªáp Trung Thu', text: caption, url: dataUrl });
        toast('ƒê√£ m·ªü chia s·∫ª ƒë∆∞·ªùng d·∫´n ·∫£nh');
        return;
      }
    }catch{}

    // 3) Ch√©p ·∫£nh v√†o clipboard
    try{
      if(navigator.clipboard && window.ClipboardItem){
        await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
        toast('ƒê√£ ch√©p ·∫£nh v√†o clipboard ‚Äî h√£y d√°n v√†o Zalo/FB');
        return;
      }
    }catch{}

    // 4) T·∫£i ·∫£nh v·ªÅ m√°y (ch·∫Øc ch·∫Øn ch·∫°y)
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='thiep-trung-thu.png';
    document.body.appendChild(a); a.click(); a.remove();
    toast('Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ chia s·∫ª tr·ª±c ti·∫øp ‚Äî ƒë√£ t·∫£i ·∫£nh ƒë·ªÉ b·∫°n g·ª≠i.');
  };

  // ========= Audio =========
  const audio = $('#bgm');
  const sfxFire = $('#phao');     // ph√°o b√¥ng g·∫ßn
  const sfxRemote = $('#phao1');  // ph√°o t·∫ßm xa

  const toggleBtn = $('#audioToggle');
  const iconPlay=$('#iconPlay'); const iconPause=$('#iconPause');
  let isPlaying=false;

  // Danh s√°ch b√†i nh·∫°c (ƒë√£ th√™m trungthu4)
  const tracks = ['trungthu.mp3','trungthu1.mp3','trungthu2.mp3','trungthu3.mp3','trungthu4.mp3'];
  let trackIndex = 0;

  function updateTrackName(){ $('#trackName').textContent = tracks[trackIndex].replace('.mp3',''); }
  function updateAudioUI(){ iconPlay.style.display = isPlaying?'none':'block'; iconPause.style.display = isPlaying?'block':'none'; }

  async function playAudio(){
    try{
      await audio.play();
      isPlaying=true; updateAudioUI();
    }catch{
      $('#audioHint').hidden=false;
    }
  }
  function pauseAudio(){ audio.pause(); isPlaying=false; updateAudioUI(); }

  // ƒê·ªïi b√†i an to√†n: t·ª± b·ªè qua b√†i l·ªói (n·∫øu kh√¥ng t·ªìn t·∫°i)
  async function setTrack(i, {autoplayIfPlaying=true} = {}){
    trackIndex = ((i % tracks.length) + tracks.length) % tracks.length;
    const wasPlaying = isPlaying;
    audio.src = tracks[trackIndex];
    updateTrackName();

    // ch·ªù canplay cho ch·∫Øc
    const waitReady = new Promise(resolve=>{
      const on = ()=>{ audio.removeEventListener('canplay', on); resolve(); };
      audio.addEventListener('canplay', on, {once:true});
      setTimeout(resolve, 1500);
    });
    audio.load();
    await waitReady;

    if(wasPlaying && autoplayIfPlaying){ await playAudio(); }
  }

  // G·∫Øn n√∫t ƒë·ªïi nh·∫°c
  $('#btnSong').onclick = async ()=>{
    await setTrack(trackIndex + 1);
    toast('ƒê√£ ƒë·ªïi nh·∫°c: ' + tracks[trackIndex].replace('.mp3',''));
    sparkle();
  };

  // N√∫t play/pause t·ªïng
  toggleBtn.onclick = ()=>{ isPlaying ? pauseAudio() : playAudio(); };
  updateTrackName();

  // Overlay
  $('#startBtn').onclick = async ()=>{ await playAudio(); $('#overlay').style.display='none'; sparkle(); };
  $('#skipBtn').onclick = ()=>{ $('#overlay').style.display='none'; };

  // ========= L∆∞u t√™n ng∆∞·ªùi g·ª≠i & Editor =========
  const fromInput = $('#fromInput'); if(fromInput){ fromInput.value = fromName || ''; }
  $('#btnSaveFrom').onclick = ()=>{ fromName = (fromInput.value||'').trim() || fromName; try{ localStorage.setItem('fromNameUser', fromName); }catch{} $('#fromLine').textContent = fromName?`T·ª´: ${fromName}`:''; toast('ƒê√£ l∆∞u t√™n ng∆∞·ªùi g·ª≠i'); };
  fromInput?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('#btnSaveFrom').click(); } });

  const customInput = $('#customInput'); customInput.value = wishes[idx] || '';
  function saveWishes(clear=false){ try{ clear ? localStorage.removeItem('wishesUser') : localStorage.setItem('wishesUser', JSON.stringify(wishes)); }catch{} }
  $('#btnUse').onclick = ()=>{ const t = (customInput.value||'').trim(); if(!t){ toast('Nh·∫≠p l·ªùi ch√∫c tr∆∞·ªõc nh√©'); return; } wishes[idx] = t; saveWishes(); render(); sparkle(); toast('ƒê√£ c·∫≠p nh·∫≠t l·ªùi ch√∫c'); };
  $('#btnAddWish').onclick = ()=>{ const t = (customInput.value||'').trim(); if(!t){ toast('Nh·∫≠p l·ªùi ch√∫c tr∆∞·ªõc nh√©'); return; } wishes.push(t); idx = wishes.length - 1; saveWishes(); render(); sparkle(); toast('ƒê√£ th√™m v√†o danh s√°ch'); };
  $('#btnReset').onclick = ()=>{ if(confirm('Kh√¥i ph·ª•c danh s√°ch l·ªùi ch√∫c g·ªëc?')){ wishes=[...defaultWishes]; idx=0; saveWishes(true); render(); toast('ƒê√£ kh√¥i ph·ª•c danh s√°ch g·ªëc'); } };

  // ========= Hi·ªáu ·ª©ng ph√°o s√°ng =========
  const fx = $('#fx'); const ctx = fx.getContext('2d'); const fxBack = $('#fxBack'); const ctxB = fxBack.getContext('2d');
  function resize(){ fx.width = innerWidth*devicePixelRatio; fx.height = innerHeight*devicePixelRatio; fxBack.width = innerWidth*devicePixelRatio; fxBack.height = innerHeight*devicePixelRatio; }
  addEventListener('resize', resize); resize();

  const MOBILE_BOOST = isMobile ? 1.15 : 1;
  const particles=[];
  function spawn(x,y,color,count=140){ count=Math.floor(count*(MOBILE_BOOST)); for(let i=0;i<count;i++){ const a=Math.random()*Math.PI*2; const s=Math.random()*4+1.8; particles.push({x:x*devicePixelRatio,y:y*devicePixelRatio,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:130+Math.random()*170,color}); } }
  function sparkle(){ const col='hsl('+ (Math.random()*360) +',100%,70%)'; spawn(innerWidth*0.5, innerHeight*0.35, col, isMobile?90:80); }
  function loop(){ ctx.globalCompositeOperation='destination-out'; ctx.fillStyle='rgba(0,0,0,0.10)'; ctx.fillRect(0,0,fx.width,fx.height); ctx.globalCompositeOperation='lighter'; for(const p of particles){ p.x+=p.vx; p.y+=p.vy; p.vy+=0.011; p.life-=1; ctx.beginPath(); const r = (isMobile?3.0:2.2)*devicePixelRatio; ctx.arc(p.x,p.y, r, 0, Math.PI*2); ctx.fillStyle=p.color; ctx.fill(); ctx.strokeStyle='rgba(255,255,255,.25)'; ctx.lineWidth=devicePixelRatio*0.6; ctx.stroke(); } for(let i=particles.length-1;i>=0;i--){ if(particles[i].life<=0) particles.splice(i,1); } requestAnimationFrame(loop); } loop();

  const sky = $('.stars');
  function makeStar(n=120){ for(let i=0;i<n;i++){ const s=document.createElement('i'); s.style.left=(Math.random()*100)+'%'; s.style.top=(Math.random()*100)+'%'; const d=1+Math.random()*3; s.style.opacity=0.6+Math.random()*0.4; s.style.animationDuration=(2.5+Math.random()*2)+'s'; s.style.transform='scale('+(d/1.6)+')'; sky.appendChild(s); } }
  function makeLanterns(n=10){ for(let i=0;i<n;i++){ const l=document.createElement('div'); l.className='lantern'; l.style.left=(Math.random()*100)+'%'; l.style.animationDuration=(12+Math.random()*8)+'s'; l.style.opacity=0.85; document.body.appendChild(l); } }
  makeStar(isMobile?110:120); makeLanterns(isMobile?10:12);

  // ====== N√∫t hi·ªáu ·ª©ng + √¢m thanh ph√°o ======
  function playSfx(el, vol=1){
    try{
      el.volume = vol;
      el.currentTime = 0; // ƒë·ªÉ b·∫•m li√™n t·ª•c v·∫´n nghe
      el.play();
    }catch{}
  }

  $('#btnFire').onclick = ()=>{ sparkle(); playSfx(sfxFire, 0.9); };
  $('#btnRemote').onclick = ()=>{ spawnShapeBack(); playSfx(sfxRemote, 1); };
  $('#btnLantern').onclick = ()=> makeLanterns(6);

  // ===== Background soft effects (cho "ph√°o t·∫ßm xa") =====
  const farParticles=[];
  function addFarPoint(cx,cy,px,py,color){ const j=0.6,s=devicePixelRatio; const vx=px*0.02+(Math.random()-0.5)*j; const vy=py*0.02+(Math.random()-0.5)*j; farParticles.push({x:(cx+px)*s,y:(cy+py)*s,vx,vy,life:260+Math.random()*160,color}); }
  function spawnShapeBack(){ const cx=innerWidth*0.55; const cy=innerHeight*0.32; const hue=Math.floor(Math.random()*360); const color='hsla('+hue+',100%,70%,0.9)'; const r=Math.min(innerWidth,innerHeight)*0.09; const N=120; for(let i=0;i<N;i++){ const t=i/N*2*Math.PI; addFarPoint(cx,cy,Math.cos(t)*r,Math.sin(t)*r,color); } }
  function loopBack(){ ctxB.globalCompositeOperation='destination-out'; ctxB.fillStyle='rgba(0,0,0,0.09)'; ctxB.fillRect(0,0,fxBack.width,fxBack.height); ctxB.globalCompositeOperation='lighter'; for(const p of farParticles){ p.x+=p.vx; p.y+=p.vy; p.vy+=0.0045; p.life-=1; ctxB.beginPath(); ctxB.arc(p.x,p.y, (isMobile?2.2:1.8)*devicePixelRatio, 0, Math.PI*2); ctxB.fillStyle=p.color; ctxB.fill(); } for(let i=farParticles.length-1;i>=0;i--){ if(farParticles[i].life<=0) farParticles.splice(i,1); } requestAnimationFrame(loopBack); }
  loopBack(); spawnShapeBack();

  // ===== Toast =====
  function toast(msg){ const t=document.createElement('div'); t.textContent=msg; Object.assign(t.style,{ position:'fixed', left:'50%', bottom:'30px', transform:'translateX(-50%)', background:'rgba(0,0,0,.7)', color:'#fff', padding:'10px 14px', borderRadius:'999px', zIndex:99, fontWeight:700 }); document.body.appendChild(t); setTimeout(()=>{ t.remove(); }, 1500); }

  </script>
</body>
</html>
